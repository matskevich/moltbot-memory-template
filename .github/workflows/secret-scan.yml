name: Secret Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for secrets
        run: |
          echo "Scanning for secrets and personal identifiers..."

          # Patterns to detect
          PATTERNS=(
            "sk-ant-[a-zA-Z0-9_-]{20,}"           # Anthropic
            "sk-proj-[a-zA-Z0-9_-]{20,}"          # OpenAI
            "gsk_[a-zA-Z0-9]{50,}"                # Groq
            "AIzaSy[a-zA-Z0-9_-]{33}"             # Google/Gemini
            "[0-9]{10}:[A-Za-z0-9_-]{35}"         # Telegram bot token
            "16643982"                            # Personal Telegram ID
            "89\.167\.22\.127"                    # Personal server IP
          )

          FOUND=0

          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.md" --include="*.sh" --include="*.json" --include="*.yml" . 2>/dev/null | grep -v ".github/workflows" | grep -v "check-secrets"; then
              echo "⚠️ Found potential secret matching: $pattern"
              FOUND=1
            fi
          done

          # Check for real API keys (not placeholders)
          if grep -rE "sk-ant-[a-zA-Z0-9_-]{50,}" --include="*.md" --include="*.json" . 2>/dev/null | grep -v "\.\.\."; then
            echo "❌ Found real Anthropic API key!"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "❌ Secrets or personal identifiers detected!"
            echo "Please replace with placeholders like YOUR_TELEGRAM_ID, YOUR_SERVER_IP, etc."
            exit 1
          fi

          echo "✅ No secrets detected"

      - name: Check for personal info
        run: |
          echo "Checking for personal information..."

          # Should not contain real personal data
          # Only check for specific patterns that shouldn't be in public repo

          # Telegram IDs (8+ digits that aren't placeholders)
          PERSONAL_IDS=$(grep -rE "allowFrom.*[0-9]{8,}" --include="*.md" --include="*.json" . 2>/dev/null | grep -v "YOUR_" | grep -v "123456789" || true)

          if [ -n "$PERSONAL_IDS" ]; then
            echo "⚠️ Found potential personal Telegram ID:"
            echo "$PERSONAL_IDS"
            exit 1
          fi

          echo "✅ No personal identifiers detected"
